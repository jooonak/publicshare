<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper
  PUBLIC "-//mybatis.org//DTD Config 3.0//EN"
  "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="org.slam.mapper.ReturnMapper">
	<select id="getList" resultMap="getMyLoanList">
		select 
		rno, book.bno, bname, publisher, owner, status, startdate 
		from 
		tbl_book book,tbl_reservation res 
		where 
		book.bno = res.bno 
		and lender = 'testUser' <!-- 추후 mid로 변경 필요 -->
		order by startdate asc, rno desc
	</select>
	
	<resultMap type="map" id="getMyLoanList">
		<collection property="BookDTO" ofType="BookDTO">
			<id property="bno" column="bno" />
			<id property="bname" column="bname" />
			<id property="publisher" column="publisher" />
			<id property="owner" column="owner" />
		</collection>
		<collection property="ReservationDTO" ofType="ReservationDTO">
			<id property="rno" column="rno" />
			<id property="status" column="status" />
			<id property="startDate" column="startdate" />
		</collection>
	</resultMap>
	
	<select id="checkItem" resultMap="checkMyItem">
		select 
			rno, book.bno, bname, publisher, lender, status, startdate 
		from 
			tbl_book book,tbl_reservation res 
		where 
			book.bno = res.bno 
			and owner = 'testOwner'
		    and status = 'onreturn'
		order by startdate asc, rno desc;

	</select>
	
	<resultMap type="map" id="checkMyItem">
		<collection property="BookDTO" ofType="BookDTO">
			<id property="bno" column="bno" />
			<id property="bname" column="bname" />
			<id property="publisher" column="publisher" />
		</collection>
		<collection property="ReservationDTO" ofType="ReservationDTO">
			<id property="rno" column="rno" />
			<id property="status" column="status" />
			<id property="startDate" column="startdate" />
			<id property="lender" column="lender" />
		</collection>
	</resultMap>
	
	<update id="returnConfirm">
		UPDATE tbl_reservation
		    SET status = (
				case status 
				when 'onloan' then 'returned'
		        when 'onres' then 'onapplyready'
		        end),
		    returndate = (case status when 'returned' then now()
		        end)
		WHERE bno = #{bno} and rno >= #{rno} and status != 'cancel'
		order by rno
		limit 2;
	</update>

	<resultMap type="map" id="detailedOnApplyMap">
		<collection property="BookDTO" ofType="BookDTO">
			<id property="bno" column="bno" />
			<id property="bname" column="bname" />
			<id property="publisher" column="publisher" />
			<id property="owner" column="owner" />
		</collection>
		<collection property="ReservationDTO" ofType="ReservationDTO">
			<id property="rno" column="rno" />
			<id property="lender" column="lender" />
			<id property="status" column="status" />
		</collection>
	</resultMap>
	
	<select id="getOnApplyReadyList" resultMap="detailedOnApplyMap">
		select
		tbl_reservation.rno rno, tbl_reservation.bno bno,
		tbl_reservation.lender, tbl_reservation.status,
		tbl_book.bname bname,
		tbl_book.publisher publisher, tbl_book.owner
		from
		(
		select
		*
		from
		tbl_reservation
		where
		lender = #{lender}
		and
		status = 'onapplyready'
		)
		tbl_reservation, tbl_book

		where tbl_reservation.bno = tbl_book.bno;
	</select>
</mapper>
